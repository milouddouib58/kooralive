# -*- coding: utf-8 -*-
import os
import json
import google.generativeai as genai


def _configure_gemini(api_key: str = None):
    """
    ุชููุฆุฉ ููุชุจุฉ Gemini ุจุงุณุชุฎุฏุงู ููุชุงุญ API.
    - ุฅุฐุง ูู ูุชู ุชูุฑูุฑ api_key ูุชู ุงูุจุญุซ ุนูู ูู ูุชุบูุฑ ุงูุจูุฆุฉ GEMINI_API_KEY.
    """
    key = api_key or os.getenv("GEMINI_API_KEY")
    if not key:
        raise RuntimeError(
            "GEMINI_API_KEY ุบูุฑ ูุถุจูุท. "
            "ุถุนู ูู Secrets ุฃู ุฃุฏุฎูู ูู ุงูุญูู ุฏุงุฎู ุงูุชุทุจูู."
        )
    genai.configure(api_key=key)


def analyze_with_gemini(
    payload: dict,
    api_key: str = None,
    model_name: str = "gemini-1.5-flash",
    temperature: float = 0.4,
    max_output_tokens: int = 1400,
    language: str = "ar",
    style: str = "ูุฎุชุตุฑ ููุงุจู ููุชูููุฐ",
) -> str:
    """
    ุชุญููู ุจูุงูุงุช ุงููุฑุงููุงุช ุจุงุณุชุฎุฏุงู ูููุฐุฌ Gemini.
    
    Args:
        payload (dict): ุงูุจูุงูุงุช ุงููุฑุงุฏ ุชุญููููุง.
        api_key (str, optional): ููุชุงุญ Gemini API.
        model_name (str): ุงุณู ุงููููุฐุฌ ุงููุณุชุฎุฏู.
        temperature (float): ุชุญูู ูู ุชููุน ุงูุฅุฌุงุจุฉ.
        max_output_tokens (int): ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงูุฑููุฒ ุงููุงุชุฌุฉ.
        language (str): ูุบุฉ ุงูุชุญููู.
        style (str): ุฃุณููุจ ุงููุชุงุจุฉ.

    Returns:
        str: ุงููุต ุงูุชุญูููู ุงููุงุชุฌ ูู Gemini.
    """
    # ุชููุฆุฉ Gemini
    _configure_gemini(api_key)

    # ุชุญููู ุงููููุฐุฌ
    model = genai.GenerativeModel(model_name)

    # ุชุญููู ุงูุจูุงูุงุช ุฅูู JSON ูุฑุชุจ
    json_blob = json.dumps(payload, ensure_ascii=False, indent=2)

    # --- ุงูุจุฑููุจุช ุงููุทูุฑ ---
    prompt = f"""
    ุฃูุช ูุญูู ูุฑุงููุงุช ุฑูุงุถูุฉ ูุฎุจูุฑ ูู ุณุฑุฏ ุงูุจูุงูุงุชุ ููููุชู ูู ุชุญููู ุจูุงูุงุช ุงูุฃูุฏุฒ ุงููุนูุฏุฉ ุฅูู ุชุญููู ูุงุถุญ ููุงุจู ููุชูููุฐ.
    ุงูุจูุงูุงุช ุงูููุฏูุฉ ูู ุจุตูุบุฉ JSON ุชุญุชูู ุนูู ุฃุณุนุงุฑ ุงูุณูู ุงููุฌูุนุฉุ ูุงูุงุญุชูุงูุงุช ุงูุนุงุฏูุฉ ุงููุญุณูุจุฉ ุจุนุฏ ุฅุฒุงูุฉ ูุงูุด ุงูุฑุจุญ (overround)ุ ูุงูุชุฑุงุญุงุช ูููู.
    ุงุณุชุฎุฏู ูุฐู ุงูุจูุงูุงุช ููุท ูุชูุฏูู ุชุญููู ุนููู ุจุงููุบุฉ "{language}" ูุจุฃุณููุจ "{style}".

    **ุงุชุจุน ุฎุทูุงุช ุงูุชูููุฑ ุงูุชุงููุฉ ุจุฏูุฉ:**

    1.  **ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุจุงุฑุงุฉ (Match Overview):** ุงุจุฏุฃ ุจุฐูุฑ ุงููุฑูููู ูุชูููุช ุงููุจุงุฑุงุฉ. ุซู ูุฏู ููุฎุตูุง ุณุฑูุนูุง ููุง ุชุดูุฑ ุฅููู ุงูุงุญุชูุงูุงุช ุงูุนุงุฏูุฉ (Fair Probs) ุจุดูู ุนุงู (ูู ูู ุงููุฑุดุญุ ูู ุงููุจุงุฑุงุฉ ูุชูุงุฑุจุฉุ).

    2.  **ุชุญููู ุณูู 1x2 (ูุชูุฌุฉ ุงููุจุงุฑุงุฉ):**
        * ูุงุฑู **ุงูุงุญุชูุงูุงุช ุงูุนุงุฏูุฉ** (`fair_probs`) ูุน **ุฃุณุนุงุฑ ุงูุณูู ุงููุฌูุนุฉ** (`aggregated`).
        * ุญุฏุฏ ุจูุถูุญ ุฃู ูุฑุตุฉ "ูููุฉ" (Value Bet). ูุฑุตุฉ ุงููููุฉ ุชุญุฏุซ ุนูุฏูุง ูููู ุงูุงุญุชูุงู ุงูุนุงุฏู ููุชูุฌุฉ ูุง ุฃุนูู ุจูุซูุฑ ูู ุงูุงุญุชูุงู ุงูุถููู ูู ุณุนุฑ ุงูุณูู (ุงูุงุญุชูุงู ุงูุถููู = 1 / ุงูุณุนุฑ).
        * ุนููู ุนูู ุญุฌู ุงูู **Overround**. ุฅุฐุง ูุงู ูุฑุชูุนูุงุ ููุฐุง ูุนูู ุฃู ูุงูุด ุฑุจุญ ุงูุณูู ูุจูุฑุ ูุงูุนูุณ ุตุญูุญ.
        * ุญูู **ุงูุชุฑุงุญุงุช ูููู** (`kelly_suggestions`). ุงุดุฑุญ ูุงุฐุง ูุนูู "Edge" (ุงูุฃูุถููุฉ) ูุญุฌู ุงูุฑูุงู ุงูููุชุฑุญ ููุณุจุฉ ูู ุงููุญูุธุฉ. ุฅุฐุง ูู ุชูู ููุงู ุงูุชุฑุงุญุงุชุ ุงุฐูุฑ ุฐูู ููุถุญ ุฃู ุงูุณูู ูุง ูุนุฑุถ ุฃู ุฃูุถููุฉ ุญุณุจ ุงููุนุงููุฑ ุงููุญุฏุฏุฉ.

    3.  **ุชุญููู ุณูู ุงูุฃูุฏุงู (Over/Under Totals):**
        * ุฑููุฒ ุนูู **ุงูุฎุท ุงููุฎุชุงุฑ** (`selected_line`).
        * ุจููุณ ุทุฑููุฉ ุชุญููู 1x2ุ ูุงุฑู ุจูู ุงูุงุญุชูุงูุงุช ุงูุนุงุฏูุฉ ูู Over ู Under ูุฃุณุนุงุฑ ุงูุณูู.
        * ุงุจุญุซ ุนู ุฃู ูุฑุตุฉ "ูููุฉ" ูู ูุฐุง ุงูุณูู ูุงุดุฑุญูุง.
        * ุญูู ุงูุชุฑุงุญุงุช ูููู ููุฐุง ุงูุณูู ุฅู ูุฌุฏุช.

    4.  **ุชูุตูุงุช ูุงุจูุฉ ููุชูููุฐ (Actionable Recommendations):**
        * ุจูุงุกู ุนูู ุชุญูููู ูู ุงูุฎุทูุงุช 2 ู 3ุ ูุฏู ูู 3 ุฅูู 5 ุชูุตูุงุช ูุงุถุญุฉ ูููุฌุฒุฉ.
        * ูุฌุจ ุฃู ุชููู ูู ุชูุตูุฉ ูุฏุนููุฉ ุจุงูุจูุงูุงุช (ูุซุงู: "ุงูุชูุตูุฉ: ุงูุฑูุงู ุนูู ููุฒ ุงููุฑูู ุงููุถูู. ุงูุณุจุจ: ุชูุซู ุงูุงุญุชูุงูุงุช ุงูุนุงุฏูุฉ (55%) ูุฑุตุฉ ูููุฉ ููุงุฑูุฉ ุจุณุนุฑ ุงูุณูู ุงูุฐู ูุนูุณ ุงุญุชูุงู 48% ููุท").
        * ุงุฎุชุชู ุจููุฑุฉ ุฅุฎูุงุก ูุณุคูููุฉ ูููุฉ ููุงุถุญุฉุ ุชุคูุฏ ุฃู ูุฐุง ุงูุชุญููู ูุจูู ุนูู ุงูุจูุงูุงุช ููุท ูููุณ ูุตูุญุฉ ูุงููุฉุ ูุฃู ุงููุฑุงููุฉ ูุณุคููุฉ ุชุฃุชู ูุน ูุฎุงุทุฑ.

    **ุดุฑูุท ุตุงุฑูุฉ ูููุฎุฑุฌุงุช:**
    -   **ูุง** ุชุนุฏ ุนุฑุถ ุจูุงูุงุช JSON.
    -   ุงุณุชุฎุฏู ุชูุณูู Markdown ุจุดูู ุงุญุชุฑุงูู ูุน ุนูุงููู ุฑุฆูุณูุฉ (ูุซู "ุชุญููู 1x2") ูููุงุท.
    -   ุงุณุชุฎุฏู ุงูุฅูููุฌูุฒ (๐ฏ, ๐, ๐, โ๏ธ) ูุฌุนู ุงูุชุญููู ุณูู ุงููุฑุงุกุฉ.
    -   ุชุฌูุจ ุงููุบุฉ ุงูุบุงูุถุฉ ุฃู ุงูุชูููุงุช. ูุฌุจ ุฃู ูููู ูู ุงุณุชูุชุงุฌ ูุฑุชุจุทูุง ุจุจูุงูุงุช ูุญุฏุฏุฉ ูู JSON.

    **ุงูุจูุงูุงุช:**
    ```json
    {json_blob}
    ```
    """

    # ุงุณุชุฏุนุงุก ุงููููุฐุฌ
    response = model.generate_content(
        prompt,
        generation_config={
            "temperature": temperature,
            "max_output_tokens": max_output_tokens,
        },
    )

    return response.text
